<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI物体検知</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        :root {
            --primary-color: #3f51b5;
            --secondary-color: #ff4081;
            --background-color: #f5f5f5;
            --text-color: #333;
            --card-background: #fff;
            --button-hover: #303f9f;
        }
        [data-theme="dark"] {
            --primary-color: #7986cb;
            --secondary-color: #ff80ab;
            --background-color: #121212;
            --text-color: #fff;
            --card-background: #1e1e1e;
            --button-hover: #5c6bc0;
        }
        body {
            margin: 0;
            padding: 0;
            font-family: 'Roboto', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        h1 {
            font-size: 24px;
            font-weight: 500;
            margin: 0;
        }
        .card {
            background-color: var(--card-background);
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        #canvasContainer {
            width: 100%;
            height: 60vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            border-radius: 8px;
            background-color: #000;
        }
        #canvas {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
        }
        button {
            background-color: var(--primary-color);
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: var(--button-hover);
        }
        #status, #error {
            margin-top: 10px;
            font-size: 14px;
        }
        #status {
            color: var(--primary-color);
        }
        #error {
            color: var(--secondary-color);
        }
        .theme-switch {
            display: flex;
            align-items: center;
        }
        .theme-switch label {
            margin-right: 10px;
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: var(--primary-color);
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>AI物体検知</h1>
            <div class="theme-switch">
                <label for="theme-toggle">ダークモード</label>
                <label class="switch">
                    <input type="checkbox" id="theme-toggle">
                    <span class="slider"></span>
                </label>
            </div>
        </header>
        <div class="card">
            <div id="canvasContainer">
                <canvas id="canvas"></canvas>
            </div>
            <div class="controls">
                <button id="cameraSwitch">
                    <i class="material-icons">flip_camera_ios</i> カメラ切替
                </button>
                <div id="status"></div>
            </div>
        </div>
        <div id="error"></div>
    </div>

    <script>
        const video = document.createElement('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const statusDiv = document.getElementById('status');
        const errorDiv = document.getElementById('error');
        const cameraSwitchBtn = document.getElementById('cameraSwitch');
        const themeToggle = document.getElementById('theme-toggle');
        let currentFacingMode = 'environment';
        let model;

        function updateStatus(message) {
            statusDiv.textContent = message;
        }

        function showError(message) {
            errorDiv.textContent = message;
        }

        async function setupCamera() {
            updateStatus("カメラを起動中...");
            const constraints = {
                video: {
                    facingMode: currentFacingMode,
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                }
            };

            try {
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                await new Promise((resolve) => {
                    video.onloadedmetadata = () => {
                        resolve(video);
                    };
                });
                video.play();
                updateCanvasSize();
                updateStatus("カメラ起動完了。物体検知を開始します。");
                runDetection();
            } catch (err) {
                console.error("カメラの起動に失敗しました: ", err);
                showError(`カメラの起動エラー: ${err.name} - ${err.message}`);
            }
        }

        function updateCanvasSize() {
            const containerWidth = canvas.parentElement.clientWidth;
            const containerHeight = canvas.parentElement.clientHeight;
            const videoAspectRatio = video.videoWidth / video.videoHeight;
            const containerAspectRatio = containerWidth / containerHeight;

            if (videoAspectRatio > containerAspectRatio) {
                canvas.width = containerWidth;
                canvas.height = containerWidth / videoAspectRatio;
            } else {
                canvas.height = containerHeight;
                canvas.width = containerHeight * videoAspectRatio;
            }
        }

        cameraSwitchBtn.onclick = async () => {
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
            }
            currentFacingMode = currentFacingMode === 'environment' ? 'user' : 'environment';
            await setupCamera();
        };

        async function loadModelAndDetect() {
            try {
                updateStatus("モデルを読み込み中...");
                model = await cocoSsd.load();
                updateStatus("モデル読み込み完了。カメラを起動します。");
                await setupCamera();
            } catch (err) {
                console.error("モデルの読み込みに失敗しました: ", err);
                showError(`モデル読み込みエラー: ${err.message}`);
            }
        }

        async function runDetection() {
            if (!model) return;
            try {
                const predictions = await model.detect(video);
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                if (predictions.length === 0) {
                    updateStatus("物体が検出されません");
                } else {
                    updateStatus(`${predictions.length}個の物体を検出`);
                }

                predictions.forEach(prediction => {
                    const [x, y, width, height] = prediction.bbox;
                    const scaledX = x * (canvas.width / video.videoWidth);
                    const scaledY = y * (canvas.height / video.videoHeight);
                    const scaledWidth = width * (canvas.width / video.videoWidth);
                    const scaledHeight = height * (canvas.height / video.videoHeight);

                    ctx.strokeStyle = '#00FFFF';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(scaledX, scaledY, scaledWidth, scaledHeight);
                    
                    ctx.fillStyle = '#00FFFF';
                    ctx.font = '16px Roboto';
                    ctx.fillText(`${prediction.class} (${Math.round(prediction.score * 100)}%)`, scaledX, scaledY > 10 ? scaledY - 5 : 10);
                });
                requestAnimationFrame(runDetection);
            } catch (err) {
                console.error("物体検知中にエラーが発生しました: ", err);
                showError(`物体検知エラー: ${err.message}`);
            }
        }

        window.addEventListener('resize', updateCanvasSize);
        window.addEventListener('orientationchange', updateCanvasSize);

        themeToggle.addEventListener('change', () => {
            document.body.setAttribute('data-theme', themeToggle.checked ? 'dark' : 'light');
        });

        loadModelAndDetect();
    </script>
</body>
</html>
